AWSTemplateFormatVersion: 2010-09-09
Description: AWS Lambda function and VPC Lattice service

Resources:
  # ---------- VPC LATTICE SERVICE ----------
  VpcLatticeService:
    Type: AWS::VpcLattice::Service
    Properties:
      Name: !Sub service-${AWS::StackName}
      AuthType: NONE
  
  VpcLatticeServiceHTTPSListener:
    Type: AWS::VpcLattice::Listener
    Properties:
      Name: https-service-listener
      ServiceIdentifier: !Ref VpcLatticeService
      Port: 443
      Protocol: HTTPS
      DefaultAction: 
        Forward:
          TargetGroups:
            - TargetGroupIdentifier: !Ref VpcLatticeTargetGroup
              Weight: 100

  VpcLatticeTargetGroup:
    Type: AWS::VpcLattice::TargetGroup
    Properties:
      Name: target-lambda
      Type: LAMBDA
      Config:
        LambdaEventStructureVersion: V2
      Targets:
        - Id: !GetAtt LambdaFunction.Arn
  
  # ---------- RAM SHARE VPC LATTICE SERVICE (AWS ORGANIZATION) ---------
  RAMShare:
    Type: AWS::RAM::ResourceShare
    Properties:
      AllowExternalPrincipals: false
      Name: service-resource-share
      Principals: 
        - !GetAtt GetOrganizationId.OrganizationArn
      ResourceArns: 
        - !GetAtt VpcLatticeService.Arn

  # ---------- LAMBDA FUNCTION ----------
  # IAM Role
  LambdaExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: lambda-vpc-lattice-role
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole

  # Lambda Function
  LambdaFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: lambda-vpclattice-target
      Handler: index.lambda_handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Runtime: python3.13
      Code:
        ZipFile: |
          import json

          def lambda_handler(event, context):    
              # Create response
              response_body = {
                  'message': 'Hello from Lambda Function!!',
              }
              
              return {
                  'statusCode': 200,
                  'headers': {
                      'Content-Type': 'application/json'
                  },
                  'body': json.dumps(response_body)
              }

  # Lambda Permission for VPC Lattice
  LambdaPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !GetAtt LambdaFunction.Arn
      Action: lambda:InvokeFunction
      Principal: vpc-lattice.amazonaws.com
      SourceArn: !GetAtt VpcLatticeTargetGroup.Arn

  # ---------- CUSTOM RESOURCE: GET ORGANIZATION ID ----------
  GetOrganizationId:
    Type: Custom::GetOrganizationId
    Properties:
      ServiceToken: !GetAtt GetOrgIdFunction.Arn

  GetOrgIdFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub get-org-id-${AWS::StackName}
      Runtime: python3.14
      Handler: index.handler
      Role: !GetAtt GetOrgIdRole.Arn
      Code:
        ZipFile: |
          import boto3
          import cfnresponse
          
          def handler(event, context):
              try:
                  if event['RequestType'] == 'Delete':
                      cfnresponse.send(event, context, cfnresponse.SUCCESS, {})
                      return
                  
                  org_client = boto3.client('organizations')
                  response = org_client.describe_organization()
                  org_id = response['Organization']['Id']
                  org_arn = response['Organization']['Arn']
                  
                  cfnresponse.send(event, context, cfnresponse.SUCCESS, {
                      'OrganizationId': org_id,
                      'OrganizationArn': org_arn
                  })
              except Exception as e:
                  print(f"Error: {str(e)}")
                  cfnresponse.send(event, context, cfnresponse.FAILED, {})

  GetOrgIdRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: OrganizationsReadAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - organizations:DescribeOrganization
                Resource: '*'

Outputs:
  ServiceDomainName:
    Value: !GetAtt VpcLatticeService.DnsEntry.DomainName